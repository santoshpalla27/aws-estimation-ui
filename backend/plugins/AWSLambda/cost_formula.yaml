service: AWSLambda
version: "1.0.0"

inputs:
  - name: memory_mb
    type: integer
    required: true
    description: "Memory allocation in MB (128-10240)"
    
  - name: avg_duration_ms
    type: integer
    required: true
    description: "Average execution duration in milliseconds"
    
  - name: invocations_per_month
    type: integer
    required: true
    description: "Number of function invocations per month"
    
  - name: architecture
    type: string
    required: false
    default: "x86_64"
    description: "Processor architecture (x86_64 or arm64)"
    
  - name: ephemeral_storage_mb
    type: integer
    required: false
    default: 512
    description: "Ephemeral storage in MB (512-10240)"

calculation_steps:
  - id: compute_gb_seconds
    description: "Calculate GB-seconds of compute time"
    formula: "(memory_mb / 1024) * (avg_duration_ms / 1000) * invocations_per_month"
    output: compute_gb_seconds
    
  - id: free_tier_gb_seconds
    description: "AWS Free Tier: 400,000 GB-seconds per month"
    formula: "400000"
    output: free_tier_compute
    
  - id: billable_gb_seconds
    description: "Compute GB-seconds after free tier"
    formula: "max(0, compute_gb_seconds - free_tier_gb_seconds)"
    output: billable_compute
    
  - id: compute_cost
    description: "Cost for compute time"
    formula: |
      if architecture == "arm64":
        billable_compute * 0.0000133334  # Graviton2 pricing
      else:
        billable_compute * 0.0000166667  # x86 pricing
    output: compute_cost
    
  - id: free_tier_requests
    description: "AWS Free Tier: 1 million requests per month"
    formula: "1000000"
    output: free_tier_requests
    
  - id: billable_requests
    description: "Requests after free tier"
    formula: "max(0, invocations_per_month - free_tier_requests)"
    output: billable_requests
    
  - id: request_cost
    description: "Cost for requests"
    formula: "billable_requests * 0.0000002"  # $0.20 per 1M requests
    output: request_cost
    
  - id: ephemeral_storage_cost
    description: "Cost for additional ephemeral storage"
    formula: |
      if ephemeral_storage_mb > 512:
        extra_gb = (ephemeral_storage_mb - 512) / 1024
        extra_gb * compute_gb_seconds * 0.0000000309
      else:
        0
    output: storage_cost

total_formula: "compute_cost + request_cost + storage_cost"

assumptions:
  - "AWS Free Tier applies (400,000 GB-seconds and 1M requests per month)"
  - "Pricing based on us-east-1 region"
  - "No provisioned concurrency configured"
  - "Standard Lambda pricing (not Lambda@Edge)"
  - "Average duration used for all invocations"

pricing_sources:
  - name: "AWS Lambda Pricing"
    url: "https://aws.amazon.com/lambda/pricing/"
    last_updated: "2024-01-01"
