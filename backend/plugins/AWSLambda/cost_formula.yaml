service: AWSLambda
version: "1.0.0"

inputs:
  - name: memory_mb
    type: integer
    required: true
    description: "Memory allocation in MB (128-10240)"
    
  - name: avg_duration_ms
    type: integer
    required: true
    description: "Average execution duration in milliseconds"
    
  - name: invocations_per_month
    type: integer
    required: true
    description: "Number of function invocations per month"
    
  - name: architecture
    type: string
    required: false
    default: "x86_64"
    description: "Processor architecture (x86_64 or arm64)"
    
  - name: ephemeral_storage_mb
    type: integer
    required: false
    default: 512
    description: "Ephemeral storage in MB (512-10240)"

calculation_steps:
  - id: compute_gb_seconds
    description: "Calculate GB-seconds of compute time"
    formula: "(memory_mb / 1024) * (avg_duration_ms / 1000) * invocations_per_month"
    output: compute_gb_seconds
    
  - id: billable_gb_seconds
    description: "Compute GB-seconds after free tier"
    formula: "max(0, compute_gb_seconds - pricing.free_tier.gb_seconds)"
    output: billable_compute
    
  - id: architecture_multiplier
    description: "Get architecture pricing multiplier"
    formula: "pricing.architecture_multipliers.get(architecture, 1.0)"
    output: arch_multiplier
    
  - id: compute_cost
    description: "Cost for compute time (with architecture multiplier)"
    formula: "billable_compute * pricing.gb_second * arch_multiplier"
    output: compute_cost
    
  - id: billable_requests
    description: "Requests after free tier"
    formula: "max(0, invocations_per_month - pricing.free_tier.requests)"
    output: billable_requests
    
  - id: request_cost
    description: "Cost for requests"
    formula: "billable_requests * pricing.request"
    output: request_cost
    
  - id: ephemeral_storage_cost
    description: "Cost for additional ephemeral storage"
    formula: |
      if ephemeral_storage_mb > 512:
        extra_gb = (ephemeral_storage_mb - 512) / 1024
        extra_gb * compute_gb_seconds * 0.0000000309
      else:
        0
    output: storage_cost

total_formula: "compute_cost + request_cost + storage_cost"

assumptions:
  - "AWS Free Tier applies (400,000 GB-seconds and 1M requests per month)"
  - "No provisioned concurrency configured"
  - "Standard Lambda pricing (not Lambda@Edge)"
  - "Average duration used for all invocations"

pricing_sources:
  - name: "AWS Lambda Pricing"
    url: "https://aws.amazon.com/lambda/pricing/"
    last_updated: "2024-01-01"
