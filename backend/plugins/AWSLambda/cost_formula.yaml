service: AWSLambda
version: "1.0.0"

inputs:
  - name: memory_mb
    type: integer
    required: true
    description: "Memory allocation in MB (128-10240)"
    
  - name: avg_duration_ms
    type: integer
    required: true
    description: "Average execution duration in milliseconds"
    
  - name: monthly_invocations
    type: integer
    required: true
    description: "Number of function invocations per month"
    
  - name: architecture
    type: string
    required: false
    default: "x86_64"
    description: "Processor architecture (x86_64 or arm64)"
    
  - name: ephemeral_storage_mb
    type: integer
    required: false
    default: 512
    description: "Ephemeral storage in MB (512-10240)"

calculation_steps:
  - id: compute_gb_seconds
    description: "Calculate GB-seconds of compute time"
    formula: (memory_mb / 1024) * (avg_duration_ms / 1000) * monthly_invocations
    output: compute_gb_seconds
    
  - id: billable_gb_seconds
    description: "Compute GB-seconds after free tier"
    formula: compute_gb_seconds - pricing.free_tier.compute_gb_seconds if compute_gb_seconds > pricing.free_tier.compute_gb_seconds else 0
    output: billable_compute
    pricing_keys:
      - free_tier.compute_gb_seconds
    
  - id: compute_cost
    description: "Cost for compute time with architecture multiplier"
    formula: billable_compute * pricing.compute.gb_second * pricing.architecture_multiplier[architecture]
    output: compute_cost
    pricing_keys:
      - compute.gb_second
      - architecture_multiplier
    
  - id: billable_requests
    description: "Requests after free tier"
    formula: monthly_invocations - pricing.free_tier.requests if monthly_invocations > pricing.free_tier.requests else 0
    output: billable_requests
    pricing_keys:
      - free_tier.requests
    
  - id: request_cost
    description: "Cost for requests"
    formula: (billable_requests / 1000000) * pricing.requests.per_million
    output: request_cost
    pricing_keys:
      - requests.per_million
    
  - id: ephemeral_storage_cost
    description: "Cost for additional ephemeral storage"
    formula: ((ephemeral_storage_mb - 512) / 1024) * compute_gb_seconds * pricing.ephemeral_storage.per_gb_second if ephemeral_storage_mb > 512 else 0
    output: storage_cost
    pricing_keys:
      - ephemeral_storage.per_gb_second

total_formula: compute_cost + request_cost + storage_cost

assumptions:
  - "AWS Free Tier applies (400,000 GB-seconds and 1M requests per month)"
  - "No provisioned concurrency configured"
  - "Standard Lambda pricing (not Lambda@Edge)"
  - "Average duration used for all invocations"
  - "arm64 architecture is 20% cheaper than x86_64"

pricing_sources:
  - name: "AWS Lambda Pricing"
    url: "https://aws.amazon.com/lambda/pricing/"
    last_updated: "2024-12-15"
