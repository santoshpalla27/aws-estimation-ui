service: AmazonEC2
formula_version: "1.0.0"

inputs:
  - name: instance_type
    type: string
    required: true
    description: "EC2 instance type (e.g., 'm5.large')"
  
  - name: instance_count
    type: integer
    required: false
    default: 1
    validation:
      min: 1
      max: 1000
  
  - name: operating_system
    type: enum
    enum_values: [Linux, Windows, RHEL, SUSE]
    default: Linux
  
  - name: ebs_volumes
    type: array
    required: false
    default: []
  
  - name: estimated_monthly_egress_gb
    type: float
    required: false
    default: 100.0
    description: "Estimated monthly data transfer out"

calculation_steps:
  - step_id: base_instance_cost
    formula: pricing.instances[instance_type] * pricing.constants.hours_per_month * instance_count * pricing.operating_system_multiplier[operating_system]
    description: "Base EC2 instance cost (on-demand, 24/7)"
    unit: USD
    pricing_keys:
      - instances
      - constants.hours_per_month
      - operating_system_multiplier
  
  - step_id: ebs_storage_cost
    formula: 0
    description: "EBS volume storage cost (simplified - $0 for now)"
    unit: USD
  
  - step_id: data_transfer_out
    formula: >
      0 if estimated_monthly_egress_gb <= pricing.data_transfer.free_tier_gb else
      (estimated_monthly_egress_gb - pricing.data_transfer.free_tier_gb) * pricing.data_transfer.tier_1_per_gb if estimated_monthly_egress_gb <= 10240 else
      (10240 - pricing.data_transfer.free_tier_gb) * pricing.data_transfer.tier_1_per_gb + (estimated_monthly_egress_gb - 10240) * pricing.data_transfer.tier_2_per_gb if estimated_monthly_egress_gb <= 51200 else
      (10240 - pricing.data_transfer.free_tier_gb) * pricing.data_transfer.tier_1_per_gb + (51200 - 10240) * pricing.data_transfer.tier_2_per_gb + (estimated_monthly_egress_gb - 51200) * pricing.data_transfer.tier_3_per_gb if estimated_monthly_egress_gb <= 153600 else
      (10240 - pricing.data_transfer.free_tier_gb) * pricing.data_transfer.tier_1_per_gb + (51200 - 10240) * pricing.data_transfer.tier_2_per_gb + (153600 - 51200) * pricing.data_transfer.tier_3_per_gb + (estimated_monthly_egress_gb - 153600) * pricing.data_transfer.tier_4_per_gb
    description: "Data transfer out cost (tiered pricing, first 100GB free)"
    unit: USD
    pricing_keys:
      - data_transfer.free_tier_gb
      - data_transfer.tier_1_per_gb
      - data_transfer.tier_2_per_gb
      - data_transfer.tier_3_per_gb
      - data_transfer.tier_4_per_gb

total_formula: base_instance_cost + ebs_storage_cost + data_transfer_out

assumptions:
  - "730 hours per month (24/7 operation)"
  - "On-demand pricing (no Reserved Instances or Savings Plans)"
  - "Data transfer within same region unless CloudFront is used"
  - "Instance pricing varies by region"
  - "Operating system affects pricing (Windows ~40% more expensive)"
